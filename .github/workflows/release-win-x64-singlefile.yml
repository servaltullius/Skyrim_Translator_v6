name: release-win-x64-singlefile

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Resolve release tag
        id: release_tag
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            $tag = "${{ github.event.release.tag_name }}"
          }
          else {
            $tag = "${{ inputs.tag }}"
          }
          "value=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Resolved release tag: $tag"

      - name: Ensure release exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "${{ steps.release_tag.outputs.value }}" --repo "${{ github.repository }}"

      - name: Restore app (win-x64)
        shell: pwsh
        run: |
          dotnet restore src/XTranslatorAi.App/XTranslatorAi.App.csproj -r win-x64 -p:EnableWindowsTargeting=true

      - name: Publish single-file EXE
        shell: pwsh
        run: |
          dotnet publish src/XTranslatorAi.App/XTranslatorAi.App.csproj -c Release -r win-x64 -o artifacts/publish-win-x64-singlefile-min -p:PublishSingleFile=true -p:SelfContained=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:EnableCompressionInSingleFile=true -p:DebugType=None -p:DebugSymbols=false -p:EnableWindowsTargeting=true -p:DeleteExistingFiles=true

      - name: Generate SHA256
        shell: pwsh
        run: |
          $exe = "artifacts/publish-win-x64-singlefile-min/TulliusTranslator.exe"
          if (!(Test-Path $exe)) {
            throw "Missing executable: $exe"
          }
          $hash = (Get-FileHash -Path $exe -Algorithm SHA256).Hash.ToLowerInvariant()
          "$hash  TulliusTranslator.exe" | Out-File -FilePath "artifacts/publish-win-x64-singlefile-min/TulliusTranslator.exe.sha256" -Encoding ascii

      - name: Upload assets to release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.release_tag.outputs.value }}" `
            "artifacts/publish-win-x64-singlefile-min/TulliusTranslator.exe" `
            "artifacts/publish-win-x64-singlefile-min/TulliusTranslator.exe.sha256" `
            --clobber `
            --repo "${{ github.repository }}"

      - name: Show release assets
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "${{ steps.release_tag.outputs.value }}" `
            --json assets `
            --jq ".assets[].name" `
            --repo "${{ github.repository }}"
